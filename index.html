<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parallel Log Analyzer — Futuristic UI</title>
  <meta name="description" content="Single-file, futuristic, interactive UI for Parallel Log Analyzer. Drag–drop logs, analyze in-browser (demo) or call your Flask backend, visualize results." />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Chart.js for visuals -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#06070d;
      --bg-2:#0b0f1a;
      --card:#0f1424cc;
      --text:#e8ecff;
      --muted:#a6b0d6;
      --accent:#7c4dff;
      --accent-2:#00d1ff;
      --success:#16c47f;
      --danger:#ff5577;
      --warning:#ffd166;
      --glass:rgba(14,18,29,0.65);
      --border:rgba(124,77,255,0.25);
      --shadow:0 10px 30px rgba(0,0,0,.45), 0 0 40px rgba(124,77,255,.15);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      background: radial-gradient(1200px 900px at 10% -20%, rgba(124,77,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 95% 10%, rgba(0,209,255,.18), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      background-attachment: fixed;
    }

    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(9,12,20,.8), rgba(9,12,20,.35));
      border-bottom:1px solid var(--border);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }

    .brand{ display:flex; align-items:center; gap:16px; }
    .logo{ width:44px; height:44px; border-radius:12px; position:relative; overflow:hidden; box-shadow: var(--shadow); }
    .logo::before{ content:""; position:absolute; inset:-30%; background:
      conic-gradient(from 0turn, var(--accent), var(--accent-2), var(--accent), var(--accent-2));
      animation:spin 6s linear infinite; filter: blur(12px); opacity:.8; }
    .logo::after{ content:"PLA"; font: 700 11px Orbitron, sans-serif; letter-spacing:1.5px; position:absolute; inset:2px; display:grid; place-items:center; color:#0b0f1a; background:#0b0f1a; border-radius:10px; }
    @keyframes spin{ to{ transform:rotate(1turn);} }

    h1{ font-family:Orbitron,Inter,sans-serif; letter-spacing:.5px; font-size:clamp(22px, 2.8vw, 34px); margin:0; }
    .subtitle{ color:var(--muted); margin-top:6px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{ appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; color:#0b0f1a; font-weight:700; letter-spacing:.3px; box-shadow: var(--shadow); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease; }
    .btn:hover{ transform: translateY(-1px); filter:brightness(1.06); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn-primary{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#051015; }
    .btn-ghost{ background: linear-gradient(135deg, rgba(124,77,255,.15), rgba(0,209,255,.15)); color:var(--text); border:1px solid var(--border); }
    .btn-outline{ background: transparent; color:var(--text); border:1px solid var(--border); }

    main{ padding:28px 24px 60px; }

    .grid{
      display:grid; gap:18px; grid-template-columns: 1.2fr 1fr; align-items:start;
    }
    @media (max-width: 1024px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden; }
    .card-h{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); }
    .card-b{ padding:16px 18px; }

    .mode-toggle{ display:flex; gap:10px; flex-wrap:wrap; }
    .mode-toggle .opt{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); cursor:pointer; color:var(--muted); }
    .mode-toggle .opt.active{ color:#051015; background:linear-gradient(135deg, var(--accent), var(--accent-2)); border:none; font-weight:800; }

    .dropzone{
      border: 2px dashed rgba(124,77,255,.35);
      border-radius:16px; padding:24px; text-align:center; background: linear-gradient(180deg, rgba(124,77,255,.05), rgba(0,0,0,0));
    }
    .dropzone.drag{ border-color: var(--accent-2); background: linear-gradient(180deg, rgba(0,209,255,.08), rgba(0,0,0,0)); }
    .dropzone input[type=file]{ display:none; }

    .meta{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:14px; }
    @media (max-width: 800px){ .meta{ grid-template-columns: repeat(2, 1fr);} }
    .kpi{ background:linear-gradient(180deg, rgba(124,77,255,.08), rgba(0,0,0,0)); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .kpi h3{ margin:0; font:800 12px/1 Orbitron, sans-serif; letter-spacing:1px; color:var(--muted); text-transform:uppercase; }
    .kpi p{ margin:8px 0 0; font:800 22px/1 Inter, sans-serif; }

    .tools{ display:flex; gap:10px; flex-wrap:wrap; }

    .split{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .table-wrap{ border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background: linear-gradient(180deg, rgba(124,77,255,.18), rgba(124,77,255,.05)); text-align:left; padding:12px; font-size:13px; letter-spacing:.4px; cursor:pointer; user-select:none; }
    tbody td{ padding:12px; border-top:1px solid rgba(255,255,255,0.06); font-size:14px; }
    tbody tr:hover{ background:rgba(124,77,255,.06); }

    .search{ display:flex; gap:10px; }
    .input{ flex:1; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:12px 14px; color:var(--text); }

    .status{ font-size:13px; color:var(--muted); }

    .chart-card canvas{ width:100%; height:320px; }

    .footer{ text-align:center; color:var(--muted); margin-top:20px; font-size:13px; }

    .tag{ font:700 11px Inter, sans-serif; color:#051015; background:linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius:999px; padding:6px 10px; display:inline-block; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Parallel Log Analyzer</h1>
          <div class="subtitle">Futuristic, interactive UI — analyze in-browser (demo) or call your Flask backend</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnDocs" class="btn btn-ghost">Quick Docs</button>
        <button id="btnTheme" class="btn btn-outline">Toggle Theme</button>
        <a class="btn btn-primary" id="btnExportJSON">Export JSON</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: Upload & Controls -->
      <section class="card">
        <div class="card-h">
          <div class="mode-toggle" role="tablist" aria-label="Analysis mode">
            <span class="opt active" data-mode="browser" role="tab" aria-selected="true">In‑Browser (Demo)</span>
            <span class="opt" data-mode="server" role="tab" aria-selected="false">Server (Flask)</span>
          </div>
          <div class="status" id="status">Idle</div>
        </div>
        <div class="card-b">
          <div id="drop" class="dropzone" tabindex="0" role="button" aria-label="Upload log or CSV">
            <p style="margin-top:0; font-size:15px; color:var(--muted);">Drag & drop a <strong>.log</strong> or <strong>.csv</strong> here, or
              <label for="file" class="tag" style="cursor:pointer;">Browse</label>
              <input id="file" type="file" accept=".log,.txt,.csv" />
            </p>
            <p style="color:var(--muted); font-size:12px; margin-bottom:0;">Tip: Use <em>In‑Browser</em> for quick demos on small/medium files. For large/production datasets, switch to <em>Server</em> to hit your Flask <code>/analyze</code> endpoint.</p>
          </div>

          <div class="meta" style="margin-top:18px;">
            <div class="kpi"><h3>Total Lines</h3><p id="kpiLines">0</p></div>
            <div class="kpi"><h3>Unique IPs</h3><p id="kpiUnique">0</p></div>
            <div class="kpi"><h3>Top Offender</h3><p id="kpiTop">—</p></div>
            <div class="kpi"><h3>Mode</h3><p id="kpiMode">In‑Browser</p></div>
          </div>

          <div class="tools" style="margin-top:14px;">
            <button id="btnAnalyze" class="btn btn-primary">Analyze</button>
            <button id="btnSample" class="btn btn-ghost">Load Sample</button>
            <button id="btnClear" class="btn btn-outline">Clear</button>
            <button id="btnFetchServerChart" class="btn btn-outline" title="Loads /chart from the Flask app">Fetch Server Chart</button>
          </div>
        </div>
      </section>

      <!-- Right: Chart -->
      <section class="card chart-card">
        <div class="card-h"><strong>Top IPs</strong><span id="chartSubtitle" class="status">No data</span></div>
        <div class="card-b">
          <canvas id="chart"></canvas>
          <img id="serverChart" alt="Server chart" style="display:none; width:100%; border-radius:12px; border:1px solid var(--border); margin-top:12px;" />
        </div>
      </section>
    </div>

    <!-- Results table -->
    <section class="card" style="margin-top:18px;">
      <div class="card-h">
        <strong>Results</strong>
        <div class="search">
          <input id="q" class="input" placeholder="Filter by IP…" />
          <button id="btnCSV" class="btn btn-outline">Download CSV</button>
        </div>
      </div>
      <div class="card-b split">
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th data-key="ip">IP</th>
                <th data-key="count">Count</th>
                <th data-key="ratio">Ratio</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="3" style="text-align:center; color:var(--muted);">No data yet</td></tr>
            </tbody>
          </table>
        </div>
        <div id="logs" class="kpi" style="min-height:120px;">
          <h3>Log</h3>
          <div id="logOut" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>
        </div>
      </div>
    </section>

    <!-- Docs modal (simple) -->
    <dialog id="docs" style="border:none; border-radius:16px; background:var(--card); color:var(--text); width:min(820px, 92vw);">
      <div style="padding:18px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border)">
        <strong style="font-family:Orbitron;">Quick Docs</strong>
        <button id="closeDocs" class="btn btn-outline">Close</button>
      </div>
      <div style="padding:18px 20px; color:var(--muted); line-height:1.6;">
        <p><strong>Server mode</strong> expects a Flask endpoint at <code>/analyze</code> that accepts <code>multipart/form-data</code> with a <code>file</code> field and returns either (a) a JSON map <code>{ "ip": count }</code> or (b) a JSON object containing a path to <code>results/analysis_result.json</code>. The server can also expose <code>/chart</code> to return the PNG bar chart.</p>
        <p><strong>In‑Browser (demo)</strong> parses the file locally with Web Workers, extracts IPv4s, applies simple heuristics (e.g., lines containing <em>fail</em>, <em>invalid</em>, <em>denied</em>, <em>drop</em>), and builds counts for quick visualization. Use it for demos, not as a replacement for your MPI backend.</p>
        <p>CSV detection is naive and supports fields like <code>srcip</code>. Adjust the parser in this file if you want other column names.</p>
      </div>
    </dialog>

    <div class="footer">Made for your Parallel Log Analyzer · Single-file UI · <span style="opacity:.8">Theme, animations, chart & exports included</span></div>
  </main>

  <script>
    // =============================
    // Utility & UI helpers
    // =============================
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const state = {
      mode: 'browser',       // 'browser' | 'server'
      rawText: '',
      filename: '',
      results: {},           // { ip: count }
      totalLines: 0,
      chart: null
    };

    const ipRegex = /(?:\d{1,3}\.){3}\d{1,3}/g;
    const badTokens = ["fail","failed","invalid","denied","unauthorized","drop","blocked","error","auth","password"]; // simple heuristics

    function log(msg){
      const out = $('#logOut');
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      out.prepend(line);
    }

    function setStatus(t){ $('#status').textContent = t; }

    function setKPIs(){
      const entries = Object.entries(state.results).sort((a,b)=>b[1]-a[1]);
      const top = entries[0] || ['—',0];
      $('#kpiLines').textContent = state.totalLines.toLocaleString();
      $('#kpiUnique').textContent = Object.keys(state.results).length.toLocaleString();
      $('#kpiTop').textContent = `${top[0]} (${top[1]})`;
      $('#kpiMode').textContent = state.mode === 'browser' ? 'In‑Browser' : 'Server';
    }

    function renderTable(){
      const tbody = $('#tbody');
      const q = $('#q').value.trim();
      const entries = Object.entries(state.results)
        .map(([ip,count])=>({ip,count}))
        .sort((a,b)=>b.count-a.count);

      const total = entries.reduce((s,r)=>s+r.count,0) || 1;
      const rows = entries
        .filter(r=>!q || r.ip.includes(q))
        .map(r=>`<tr><td>${r.ip}</td><td>${r.count.toLocaleString()}</td><td>${((r.count/total)*100).toFixed(2)}%</td></tr>`)
        .join('');
      tbody.innerHTML = rows || `<tr><td colspan="3" style="text-align:center; color:var(--muted);">No matching results</td></tr>`;

      // sortable headers
      $$('thead th').forEach(th=>{
        th.onclick = () => {
          const key = th.dataset.key;
          const arr = Object.entries(state.results).map(([ip,count])=>({ip,count,ratio:count/total}));
          arr.sort((a,b)=>{
            if(key==='ip') return a.ip.localeCompare(b.ip, undefined, {numeric:true});
            if(key==='count') return b.count - a.count;
            if(key==='ratio') return b.ratio - a.ratio;
          });
          state.results = arr.reduce((o,r)=>(o[r.ip]=r.count,o),{});
          renderTable();
        }
      });
    }

    function renderChart(){
      const ctx = $('#chart');
      const entries = Object.entries(state.results).sort((a,b)=>b[1]-a[1]).slice(0,20);
      const labels = entries.map(e=>e[0]);
      const data = entries.map(e=>e[1]);

      $('#chartSubtitle').textContent = entries.length ? `Top ${entries.length} IPs` : 'No data';
      $('#serverChart').style.display = 'none';

      if(state.chart){ state.chart.destroy(); }
      state.chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Count', data, borderWidth: 1 }] },
        options: {
          responsive:true,
          aspectRatio: 2.2,
          scales: { x: { ticks: { color:'#c9d1ff' } }, y: { ticks: { color:'#c9d1ff' }, beginAtZero:true } },
          plugins: {
            legend: { labels: { color:'#c9d1ff' } },
            tooltip: { callbacks: { label: (ctx)=>` ${ctx.formattedValue}` } }
          }
        }
      });
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state.results, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (state.filename?.replace(/\.[^.]+$/, '') || 'analysis') + '.json';
      a.click();
    }

    function exportCSV(){
      const rows = [['ip','count']].concat(Object.entries(state.results));
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (state.filename?.replace(/\.[^.]+$/, '') || 'analysis') + '.csv';
      a.click();
    }

    // =============================
    // Browser (demo) analyzer via Web Worker
    // =============================
    const workerCode = `
      const ipRe = /(?:\\d{1,3}\\.){3}\\d{1,3}/g;
      const bad = ["fail","failed","invalid","denied","unauthorized","drop","blocked","error","auth","password"];
      function analyzeText(text){
        const counts = Object.create(null);
        const lines = text.split(/\r?\n/);
        let n = 0;
        for(const line of lines){
          n++;
          if(n % 5000 === 0) postMessage({type:'progress', n});
          // Heuristic: require at least one token to reduce noise
          const low = line.toLowerCase();
          if(!bad.some(t=>low.includes(t))){
            // still allow IP-only rows if very short
            if(line.length > 120) continue;
          }
          const ips = line.match(ipRe);
          if(!ips) continue;
          for(const ip of ips){ counts[ip] = (counts[ip]||0) + 1; }
        }
        return {counts, total: lines.length};
      }
      function analyzeCSV(text){
        // tiny CSV detection and srcip column fallback
        const lines = text.split(/\r?\n/);
        const headers = (lines[0]||'').split(',');
        const idx = headers.findIndex(h=>/srcip|source_ip|ip/gi.test(h));
        const counts = Object.create(null);
        let total = lines.length;
        for(let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          if(idx >= 0){
            const ip = (cols[idx]||'').trim();
            if(ip) counts[ip] = (counts[ip]||0) + 1;
          } else {
            const ips = lines[i].match(ipRe);
            if(!ips) continue; for(const ip of ips){ counts[ip]=(counts[ip]||0)+1; }
          }
          if(i % 5000 === 0) postMessage({type:'progress', n:i});
        }
        return {counts, total};
      }
      onmessage = (e)=>{
        const { text, isCSV } = e.data;
        const res = isCSV ? analyzeCSV(text) : analyzeText(text);
        postMessage({type:'done', ...res});
      };
    `;
    const workerURL = URL.createObjectURL(new Blob([workerCode], {type:'text/javascript'}));
    const worker = new Worker(workerURL);

    worker.onmessage = (e)=>{
      const {type} = e.data;
      if(type==='progress'){
        setStatus(`Parsing… ${e.data.n.toLocaleString()} lines`);
      } else if(type==='done'){
        state.results = e.data.counts || {};
        state.totalLines = e.data.total || 0;
        setKPIs(); renderTable(); renderChart(); setStatus('Done');
        log(`Analysis complete. ${Object.keys(state.results).length} unique IPs.`);
      }
    };

    async function analyzeBrowser(text, isCSV){
      setStatus('Parsing…'); log('Starting in‑browser analysis');
      worker.postMessage({ text, isCSV });
    }

    // =============================
    // Server mode helpers
    // =============================
    async function analyzeServer(file){
      setStatus('Uploading…'); log('Uploading file to /analyze');
      const fd = new FormData(); fd.append('file', file);
      const res = await fetch('/analyze', { method:'POST', body: fd });

      let data;
      try {
        data = await res.json();
      } catch(err){
        // Fallback: fetch results file if server returns non-JSON page
        log('Server returned non‑JSON. Attempting to load /results/analysis_result.json…');
      }

      if(data){
        // try direct map
        if(data && !data.result && !data.path){
          state.results = data; // assume { ip: count }
        } else if(data.result){
          state.results = data.result;
        } else if(data.path || data.url){
          const url = data.url || data.path;
          const r = await fetch(url);
          state.results = await r.json();
        }
      } else {
        // second fallback path
        const r = await fetch('/results/analysis_result.json');
        state.results = await r.json();
      }

      // attempt to load server chart
      $('#serverChart').src = '/chart?ts=' + Date.now();
      setStatus('Rendering…');
      state.totalLines = Object.values(state.results).reduce((s,c)=>s+c,0);
      setKPIs(); renderTable(); renderChart(); setStatus('Done');
      log('Server analysis complete.');
    }

    // =============================
    // File ingest
    // =============================
    function isCSVName(name){ return /\.csv$/i.test(name||''); }

    function readFileAsText(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject; fr.readAsText(file);
      });
    }

    // =============================
    // Event wiring
    // =============================
    function setMode(m){
      state.mode = m; setKPIs();
      $$('.mode-toggle .opt').forEach(el=>{
        const on = el.dataset.mode === m; el.classList.toggle('active', on); el.setAttribute('aria-selected', on);
      });
      log(`Mode changed to ${m}`);
    }

    $$('.mode-toggle .opt').forEach(el=> el.addEventListener('click', ()=> setMode(el.dataset.mode)) );

    // Drag-drop
    const dz = $('#drop');
    const fileInput = $('#file');
    dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
    dz.addEventListener('dragleave', ()=> dz.classList.remove('drag') );
    dz.addEventListener('drop', e=>{
      e.preventDefault(); dz.classList.remove('drag');
      const f = e.dataTransfer.files?.[0]; if(!f) return; fileInput.files = e.dataTransfer.files; onFilePicked(f);
    });
    fileInput.addEventListener('change', ()=>{ const f = fileInput.files?.[0]; if(f) onFilePicked(f); });

    function onFilePicked(f){ state.filename = f.name; log(`Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`); }

    $('#btnAnalyze').addEventListener('click', async ()=>{
      const f = fileInput.files?.[0];
      if(!f && !state.rawText){ alert('Pick a file or load sample first.'); return; }
      if(state.mode === 'server'){
        if(!f){ alert('Server mode requires a file.'); return; }
        await analyzeServer(f);
      } else {
        const text = f ? await readFileAsText(f) : state.rawText; const csv = f ? isCSVName(f.name) : false; await analyzeBrowser(text, csv);
      }
    });

    $('#btnSample').addEventListener('click', ()=>{
      const demo = `
      Nov 11 12:01:22 host sshd[1234]: Failed password for invalid user admin from 211.167.68.59 port 55432 ssh2\n
      Nov 11 12:01:24 host sshd[1234]: Failed password for root from 210.245.165.136 port 55433 ssh2\n
      Nov 11 12:02:01 host kernel: DROP IN=eth0 OUT= MAC=... SRC=218.188.2.4 DST=10.0.0.12 LEN=60 ...\n
      2025-11-11T12:02:41Z app[web]: ERROR auth login failed for user=guest ip=211.167.68.59\n
      2025-11-11T12:03:11Z app[api]: unauthorized request from 210.245.165.136 path=/admin\n
      2025-11-11T12:04:01Z fw: blocked src=211.167.68.59 dst=10.0.0.18\n      `;
      state.rawText = demo; state.filename = 'sample.log'; log('Loaded inline sample'); setStatus('Sample ready');
    });

    $('#btnClear').addEventListener('click', ()=>{
      state.results = {}; state.totalLines = 0; state.rawText = ''; state.filename='';
      setKPIs(); renderTable(); renderChart(); setStatus('Cleared'); $('#serverChart').style.display='none';
    });

    $('#btnDocs').addEventListener('click', ()=> $('#docs').showModal());
    $('#closeDocs').addEventListener('click', ()=> $('#docs').close());

    $('#btnExportJSON').addEventListener('click', exportJSON);
    $('#btnCSV').addEventListener('click', exportCSV);

    $('#q').addEventListener('input', renderTable);

    $('#btnFetchServerChart').addEventListener('click', ()=>{
      $('#serverChart').src = '/chart?ts=' + Date.now();
      $('#serverChart').style.display = 'block';
      $('#chartSubtitle').textContent = 'Server chart loaded below';
      log('Fetched /chart from server');
    });

    // Theme toggle (simple invert)
    $('#btnTheme').addEventListener('click', ()=>{
      const dark = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() === '#06070d';
      if(dark){
        document.documentElement.style.setProperty('--bg', '#eef1ff');
        document.documentElement.style.setProperty('--bg-2', '#e2e6ff');
        document.documentElement.style.setProperty('--card', '#ffffffcc');
        document.documentElement.style.setProperty('--text', '#0b0f1a');
        document.documentElement.style.setProperty('--muted', '#495079');
        document.documentElement.style.setProperty('--border', 'rgba(124,77,255,0.25)');
      } else {
        document.documentElement.style.setProperty('--bg', '#06070d');
        document.documentElement.style.setProperty('--bg-2', '#0b0f1a');
        document.documentElement.style.setProperty('--card', '#0f1424cc');
        document.documentElement.style.setProperty('--text', '#e8ecff');
        document.documentElement.style.setProperty('--muted', '#a6b0d6');
        document.documentElement.style.setProperty('--border', 'rgba(124,77,255,0.25)');
      }
      renderChart();
    });

    // Init
    setKPIs();
    renderTable();
  </script>
</body>
</html>
